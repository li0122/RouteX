<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet åœ°åœ–æ¸¬è©¦ - RouteX</title>
    <link rel="stylesheet" href="/static/lib/leaflet/leaflet.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 30px 0;
        }
        .test-section h2 {
            color: #764ba2;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-start {
            background: #10b981;
            color: white;
        }
        .btn-end {
            background: #ef4444;
            color: white;
        }
        .btn-test {
            background: #3b82f6;
            color: white;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .info-box {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .success-box {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .status {
            font-family: monospace;
            background: #1e293b;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-line {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ Leaflet åœ°åœ–æ¸¬è©¦é é¢</h1>
        <p class="subtitle">RouteX - Leaflet + OSM æ•´åˆé©—è­‰</p>

        <!-- æ¸¬è©¦ 1: åœ°åœ–é¸æ“‡å™¨ -->
        <div class="test-section">
            <h2>ğŸ“ æ¸¬è©¦ 1: åœ°åœ–é¸æ“‡å™¨</h2>
            <div class="info-box">
                <strong>åŠŸèƒ½æ¸¬è©¦ï¼š</strong>é»æ“Šåœ°åœ–é¸æ“‡èµ·é»å’Œçµ‚é»
            </div>
            
            <div id="test-map-picker"></div>
            
            <div class="button-group">
                <button class="btn-start" onclick="testMapPicker.setMode('start')">
                    ğŸŸ¢ è¨­å®šèµ·é»
                </button>
                <button class="btn-end" onclick="testMapPicker.setMode('end')">
                    ğŸ”´ è¨­å®šçµ‚é»
                </button>
                <button class="btn-test" onclick="quickTestPicker()">
                    âš¡ å¿«é€Ÿæ¸¬è©¦ï¼ˆé‡‘é–€å¤§æ©‹â†’æ¼äººç¢¼é ­ï¼‰
                </button>
            </div>
            
            <div class="success-box" id="picker-status">
                <div><strong>èµ·é»ï¼š</strong><span id="start-display">æœªè¨­å®š</span></div>
                <div><strong>çµ‚é»ï¼š</strong><span id="end-display">æœªè¨­å®š</span></div>
            </div>
        </div>

        <!-- æ¸¬è©¦ 2: çµæœåœ°åœ– -->
        <div class="test-section">
            <h2>ğŸ¯ æ¸¬è©¦ 2: çµæœåœ°åœ–èˆ‡ OSRM è·¯ç·š</h2>
            <div class="info-box">
                <strong>åŠŸèƒ½æ¸¬è©¦ï¼š</strong>é¡¯ç¤ºæ¨è–¦åœ°é»å’Œ OSRM å¯¦éš›è·¯ç·š
            </div>
            
            <div id="test-result-map"></div>
            
            <div class="button-group">
                <button class="btn-test" onclick="testShortRoute()">
                    æ¸¬è©¦çŸ­ç¨‹è·¯ç·šï¼ˆå°åŒ—å¸‚å€ï¼‰
                </button>
                <button class="btn-test" onclick="testSFRoute()">
                    æ¸¬è©¦èˆŠé‡‘å±±è·¯ç·š
                </button>
                <button class="btn-test" onclick="clearResultMap()">
                    æ¸…é™¤åœ°åœ–
                </button>
            </div>
        </div>

        <!-- ç‹€æ…‹æ—¥èªŒ -->
        <div class="test-section">
            <h2>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h2>
            <div class="status" id="log-container">
                <div class="status-line">ç­‰å¾…æ¸¬è©¦...</div>
            </div>
        </div>
    </div>

    <script src="/static/lib/leaflet/leaflet.js"></script>
    <script src="/static/lib/mbtiles/sql-wasm.js"></script>
    <script src="/static/lib/mbtiles/leaflet-mbtiles.js"></script>
    <script src="/static/js/leaflet-map-picker.js"></script>
    <script src="/static/js/leaflet-result-map.js"></script>
    <script>
        let testMapPicker = null;
        let testResultMap = null;
        let logLines = [];

        // æ—¥èªŒå‡½æ•¸
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
            const line = `[${timestamp}] ${prefix} ${message}`;
            logLines.push(line);
            if (logLines.length > 50) logLines.shift();
            
            const container = document.getElementById('log-container');
            container.innerHTML = logLines.map(l => `<div class="status-line">${l}</div>`).join('');
            container.scrollTop = container.scrollHeight;
            
            console.log(message);
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('é é¢åŠ è¼‰å®Œæˆï¼Œåˆå§‹åŒ–æ¸¬è©¦ç’°å¢ƒ...');
            
            // åˆå§‹åŒ–åœ°åœ–é¸æ“‡å™¨
            try {
                testMapPicker = new LeafletMapPicker('test-map-picker');
                log('åœ°åœ–é¸æ“‡å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // ç›£è½èµ·çµ‚é»è®ŠåŒ–
                const originalSetStart = testMapPicker.setStartLocation.bind(testMapPicker);
                testMapPicker.setStartLocation = function(lat, lng) {
                    originalSetStart(lat, lng);
                    document.getElementById('start-display').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    log(`èµ·é»å·²è¨­å®š: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
                };
                
                const originalSetEnd = testMapPicker.setEndLocation.bind(testMapPicker);
                testMapPicker.setEndLocation = function(lat, lng) {
                    originalSetEnd(lat, lng);
                    document.getElementById('end-display').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    log(`çµ‚é»å·²è¨­å®š: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
                };
                
            } catch (error) {
                log(`åœ°åœ–é¸æ“‡å™¨åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
            }
            
            // åˆå§‹åŒ–çµæœåœ°åœ–
            try {
                testResultMap = new LeafletResultMap('test-result-map');
                log('çµæœåœ°åœ–åˆå§‹åŒ–æˆåŠŸ', 'success');
            } catch (error) {
                log(`çµæœåœ°åœ–åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
            }
        });

        // å¿«é€Ÿæ¸¬è©¦é¸æ“‡å™¨
        function quickTestPicker() {
            log('åŸ·è¡Œå¿«é€Ÿæ¸¬è©¦ï¼šé‡‘é–€å¤§æ©‹ â†’ æ¼äººç¢¼é ­');
            testMapPicker.setStartLocation(37.8199, -122.4783);
            testMapPicker.setEndLocation(37.8080, -122.4177);
            log('å¿«é€Ÿæ¸¬è©¦å®Œæˆ', 'success');
        }

        // æ¸¬è©¦çŸ­ç¨‹è·¯ç·šï¼ˆå°åŒ—ï¼‰
        function testShortRoute() {
            log('æ¸¬è©¦çŸ­ç¨‹è·¯ç·šï¼šå°åŒ—å¸‚å€');
            
            const testData = {
                start_location: [25.0330, 121.5654],  // å°åŒ— 101
                end_location: [25.0478, 121.5170],    // å°åŒ—è»Šç«™
                recommendations: [
                    {
                        poi: {
                            name: 'ä¸­æ­£ç´€å¿µå ‚',
                            latitude: 25.0361,
                            longitude: 121.5202,
                            primary_category: 'æ­·å²å»ºç¯‰',
                            avg_rating: 4.5,
                            num_reviews: 12500
                        },
                        score: 0.892,
                        extra_time_minutes: 15,
                        llm_approved: true
                    },
                    {
                        poi: {
                            name: 'å°åŒ—æ¤ç‰©åœ’',
                            latitude: 25.0307,
                            longitude: 121.5089,
                            primary_category: 'å…¬åœ’',
                            avg_rating: 4.2,
                            num_reviews: 3200
                        },
                        score: 0.845,
                        extra_time_minutes: 12,
                        llm_approved: true
                    }
                ]
            };
            
            testResultMap.setData(testData);
            log('å°åŒ—æ¸¬è©¦è·¯ç·šå·²è¼‰å…¥', 'success');
        }

        // æ¸¬è©¦èˆŠé‡‘å±±è·¯ç·š
        function testSFRoute() {
            log('æ¸¬è©¦èˆŠé‡‘å±±è·¯ç·š');
            
            const testData = {
                start_location: [37.8199, -122.4783],  // é‡‘é–€å¤§æ©‹
                end_location: [37.7880, -122.4075],    // è¯åˆå»£å ´
                recommendations: [
                    {
                        poi: {
                            name: 'æ¼äººç¢¼é ­',
                            latitude: 37.8080,
                            longitude: -122.4177,
                            primary_category: 'æ—…éŠæ™¯é»',
                            avg_rating: 4.3,
                            num_reviews: 45000
                        },
                        score: 0.915,
                        extra_time_minutes: 20,
                        llm_approved: true
                    },
                    {
                        poi: {
                            name: 'Pier 39',
                            latitude: 37.8087,
                            longitude: -122.4098,
                            primary_category: 'è³¼ç‰©ä¸­å¿ƒ',
                            avg_rating: 4.4,
                            num_reviews: 38000
                        },
                        score: 0.888,
                        extra_time_minutes: 18,
                        llm_approved: true
                    },
                    {
                        poi: {
                            name: 'Ghirardelli Square',
                            latitude: 37.8055,
                            longitude: -122.4228,
                            primary_category: 'è³¼ç‰©ä¸­å¿ƒ',
                            avg_rating: 4.5,
                            num_reviews: 15000
                        },
                        score: 0.856,
                        extra_time_minutes: 15,
                        llm_approved: true
                    }
                ]
            };
            
            testResultMap.setData(testData);
            log('èˆŠé‡‘å±±æ¸¬è©¦è·¯ç·šå·²è¼‰å…¥ï¼Œç­‰å¾… OSRM è·¯ç·š...', 'success');
        }

        // æ¸…é™¤çµæœåœ°åœ–
        function clearResultMap() {
            if (testResultMap) {
                testResultMap.clearMap();
                log('çµæœåœ°åœ–å·²æ¸…é™¤');
            }
        }
    </script>
</body>
</html>
